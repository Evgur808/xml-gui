<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Генератор XML</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;
    }
    h1,h2 { margin-top: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row { display: grid; gap: 6px; }
    label { font-size: 13px; }
    input, select, textarea, button {
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    textarea {
      min-height: 280px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .req::after { content: " *"; color: #c00; }
    .err { color: #c00; font-size: 13px; }
    .ok  { color: #0a7; font-size: 13px; }
    .bar { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0; align-items: center; }

    /* кнопки — визуальный эффект */
    button {
      cursor: pointer;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      transition: transform .06s ease, box-shadow .15s ease, background-color .15s ease;
    }
    button:hover {
      background: #f7f7f7;
      box-shadow: 0 3px 10px rgba(0,0,0,.12);
    }
    button:active {
      transform: translateY(1px) scale(.98);
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
    }
    button:disabled {
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>

<h1>Генератор XML для тестов</h1>

<h2>Организация</h2>
<div class="grid">
  <div class="row">
    <label class="req">InstitutionINN (10 цифр)</label>
    <input id="InstitutionINN" maxlength="10" />
    <div id="err_inn" class="err"></div>

    <button id="btnLookup" type="button" onclick="app.lookup()">Подтянуть InstitutionName + OGRN по ИНН</button>
    <div id="lookupMsg"></div>
  </div>

  <div class="row">
    <label class="req">InstitutionName</label>
    <input id="InstitutionName" />
    <label class="req">InstitutionOGRN</label>
    <input id="InstitutionOGRN" />
  </div>
</div>

<h2>Пользователь</h2>
<div class="grid">
  <div class="row">
    <label class="req">PersonUID</label>
    <input id="PersonUID" />
  </div>
  <div class="row">
    <label class="req">FirstName</label>
    <input id="FirstName" />
  </div>
  <div class="row">
    <label class="req">LastName</label>
    <input id="LastName" />
  </div>
  <div class="row">
    <label>MiddleName</label>
    <input id="MiddleName" />
  </div>
</div>

<h2>Employments.Value</h2>
<div class="grid">
  <div class="row">
    <label class="req">InstitutionType</label>
    <select id="InstitutionType">
      <option value="grbs">grbs</option>
      <option value="organization">organization</option>
      <option value="cb">cb</option>
      <option value="mo">mo</option>
    </select>
  </div>
  <div class="row">
    <label class="req">Position</label>
    <input id="Position" />
  </div>
  <div class="row">
    <label class="req">VidJob</label>
    <select id="VidJob">
      <option value="Основное место работы">Основное место работы</option>
      <option value="Совместительство">Совместительство</option>
    </select>
  </div>
  <div class="row">
    <label class="req">Deleted</label>
    <select id="Deleted">
      <option value="false">false</option>
      <option value="true">true</option>
    </select>
  </div>
</div>

<h2>Request</h2>
<div class="grid">
  <div class="row">
    <label class="req">Request Type</label>
    <select id="RequestType">
      <option value="connect">connect</option>
      <option value="change">change</option>
    </select>
  </div>
  <div class="row">
    <label class="req">Request UID</label>
    <input id="RequestUID" />
  </div>
</div>

<div class="bar">
  <button type="button" onclick="app.generate()">Сгенерировать XML</button>
  <button id="btnDownload" type="button" onclick="app.download()" disabled>Скачать data.xml</button>
  <span id="formMsg"></span>
</div>

<label>XML</label>
<textarea id="xmlOut" readonly></textarea>

<script>
const WORKER_URL = "https://flat-fire-237d.evgur808.workers.dev/party";

const CONST = {
  TypeExportData: "ПользователиДляБПЭК",
  PackageVersion: "2026-01-01",
  InsuranceNumber: "01234567890",
  PersonWorkEmail: "evgenii.gurbanovskii@unicardtech.ru",
  PersonINN: "012345678912",
  PersonWorkPhone: "78127770011",
  InnGRBS: "",
  InnCB: "",
  RequestInfoSystemName: "АИС БП-ЭК",
  RowName: "Functional_role",
  RowValueName: "Не заполняется пользователем",
};

const $ = (id) => document.getElementById(id);

function nowMoscowISO() {
  return new Date().toLocaleString("sv-SE", { timeZone: "Europe/Moscow", hour12: false }).replace(" ", "T");
}

function escapeXml(v) {
  return String(v)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll("\"","&quot;")
    .replaceAll("'","&apos;");
}

async function lookup() {
  const btn = $("btnLookup");
  const inn = $("InstitutionINN").value.trim();
  $("lookupMsg").textContent = "";

  if (!/^\d{10}$/.test(inn)) {
    $("lookupMsg").textContent = "Ошибка: ИНН должен быть 10 цифр";
    return;
  }

  btn.disabled = true;
  btn.textContent = "Ищу...";

  try {
    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ inn })
    });
    const j = await r.json();
    const s = j.suggestions?.[0];
    if (!s) throw new Error("Не найдено");

    $("InstitutionName").value = s.data.name.full_with_opf || s.value;
    $("InstitutionOGRN").value = s.data.ogrn;
    $("lookupMsg").textContent = "Ок";
    $("lookupMsg").className = "ok";
  } catch (e) {
    $("lookupMsg").textContent = "Ошибка";
    $("lookupMsg").className = "err";
  } finally {
    btn.disabled = false;
    btn.textContent = "Подтянуть InstitutionName + OGRN по ИНН";
  }
}

function generate() {
  const required = ["InstitutionINN","InstitutionName","InstitutionOGRN","PersonUID","FirstName","LastName","Position","RequestUID"];
  for (const id of required) {
    if (!$(id).value.trim()) {
      $("formMsg").textContent = "Не заполнены обязательные поля";
      $("formMsg").className = "err";
      return;
    }
  }

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<Data TypeExportData="${CONST.TypeExportData}"
      PackageVersion="${CONST.PackageVersion}"
      DateUnload="${nowMoscowISO()}">
  <DataInstitution InstitutionINN="${$("InstitutionINN").value}"
                   InstitutionName="${escapeXml($("InstitutionName").value)}"
                   InstitutionOGRN="${$("InstitutionOGRN").value}"
                   InnGRBS=""
                   InnCB="">
    <Person PersonUID="${$("PersonUID").value}"
            FirstName="${escapeXml($("FirstName").value)}"
            LastName="${escapeXml($("LastName").value)}"
            InsuranceNumber="${CONST.InsuranceNumber}"
            PersonINN="${CONST.PersonINN}"
            PersonWorkEmail="${CONST.PersonWorkEmail}"
            PersonWorkPhone="${CONST.PersonWorkPhone}">
      <Employments>
        <Value InstitutionINN="${$("InstitutionINN").value}"
               InstitutionName="${escapeXml($("InstitutionName").value)}"
               InstitutionType="${$("InstitutionType").value}"
               Position="${escapeXml($("Position").value)}"
               VidJob="${$("VidJob").value}"
               Deleted="${$("Deleted").value}"/>
      </Employments>
    </Person>
    <Request InfoSystemName="${CONST.RequestInfoSystemName}"
             Type="${$("RequestType").value}"
             UID="${$("RequestUID").value}">
      <Row Name="${CONST.RowName}">
        <Value Name="${CONST.RowValueName}"/>
      </Row>
    </Request>
  </DataInstitution>
</Data>`;

  $("xmlOut").value = xml;
  $("formMsg").textContent = "XML сгенерирован";
  $("formMsg").className = "ok";
  $("btnDownload").disabled = false;
}

function download() {
  const b = new Blob([$("xmlOut").value], { type: "application/xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "data.xml";
  a.click();
  URL.revokeObjectURL(a.href);
}

window.app = { lookup, generate, download };
</script>
</body>
</html>
